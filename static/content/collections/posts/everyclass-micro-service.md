---
title: 每课的 micro-service 架构演进之路
created_at: 2018-11-21T14:43:21.767Z
tags:
  - micro-service
  - architecture
  - everyclass
authors: Frederic Chan
categories: Admirable Insight
meta:
  keywords: everyclass 每课 微服务 架构 演进
isPage: false
isFeatured: true
hero:
  image: /images/uploads/staircase-274614_1280.jpg
excerpt: >-
  应老师的邀请，我在 SOA（面向服务的架构）课堂上分享了每课的微服务架构演进之路。本篇文章收录了分享的讲稿和
  PPT，作为一个架构演进的记录，也希望能帮助到其他人。
---
大家好，我是詹泽宇，今天我和大家分享一下每课的微服务架构演进之路。

![01](https://images.cdn.admirable.pro/everyclass-micro-service-arch.001.jpeg)


-----


首先简单介绍一下每课是什么，虽然每课在学校里已经很有名气了，但是不一定在座的每个人都知道，所以我简单介绍一下每课。每课是一款校内 web 应用，它可以把你的课表导入手机日历，不需要安装任何 APP 就可以在手机日历中查看自己的课程以及其他日程安排。你还可以查询和自己上同一节课的同学，甚至还能查询别人的课表。

![02](https://images.cdn.admirable.pro/everyclass-micro-service-arch.002.jpeg)


------


作为一款面向中南大学本科生的校内应用，我们的单日最高访问量达到了 3.3 万，总访问量达到了 93 万，可能是教务系统之外中南大学校内访问量最大、最流行的应用。并且曾经非常难得的作为一款非官方应用被校团委微信公众号推荐。

![03](https://images.cdn.admirable.pro/everyclass-micro-service-arch.003.jpeg)



-----


每课的架构演化大概分为以下四个阶段。接下来我会按照这个顺序来讲述每课的架构演化路线。

![04](https://images.cdn.admirable.pro/everyclass-micro-service-arch.004.jpeg)

在最开始，和所有互联网产品一样，我们也是从一台服务器开始的。我在一台云服务器上手动配置了环境、部署了应用本体、并搭建了 MySQL 数据库。每次需要版本升级的时候，我需要手动 ssh 连接到服务器，然后 git pull，再重新启动应用服务器。相信这种原始的架构是绝大部分学生做项目的常态，它的问题是显而易见的：

* 升级应用需要 SSH 连接服务器手动操作，版本迭代频繁的时候非常麻烦
* 应用服务器出现性能瓶颈时无法水平扩展
* 所有应用和数据库共享一个 Host 的资源，无法控制各应用所使用的资源量，容易互相影响，单点问题可能导致全局崩溃

![05](https://images.cdn.admirable.pro/everyclass-micro-service-arch.005.jpeg)

------


于是在2018年5月，我们的产品转向了基于 Docker 和自己写的部署脚本的容器化部署。请注意一下，上一张图片中应用和数据库的边界是虚线，代表他们的隔离程度不高。而这张图中各个组件的边界变成了实线，这是因为通过容器化的部署，我们已经可以分别限制各个组件使用的 CPU、内存等资源。通过容器之间的隔离，我们在单台主机上避免了单点故障引起的整台服务器崩溃。
另外，借助于容器技术，我们已经可以在单台主机上部署一个应用的多个副本，更好地降低访问延时并提高服务稳定性。
同时，这个时候我们引入了持续集成机制。当我们把代码推向 GitHub 的 Master 分支时，持续集成系统（Travis CI）会自动拉取代码并执行单元测试，测试通过之后会执行服务器上的升级脚本，对生产环境的版本进行滚动升级。滚动升级保证了升级时不会出现服务中断，不过在这个时候我们还没有引入回滚机制，如果当前版本有 bug，需要手动停掉新版本容器然后启动旧版本容器。



![06](https://images.cdn.admirable.pro/everyclass-micro-service-arch.006.jpeg)

总结一下，在这个阶段我们实现了资源隔离、持续集成、无间断的升级和服务的横向扩展。但是依然存在一些问题：
容器需要手动分配固定的端口，否则执行滚动升级脚本后负载均衡器找不到容器的新端口号。扩容时需要修改负载均衡的配置文件，水平扩容并不是非常便利。
因为这个时候我们已经有了除了我的其他开发者加入了，根据业务规划，每课未来会新增多个微服务，包括学生身份校验、API 开放平台等，微服务间有互相通信的需求。而 Docker 容器内部并不知道外部正在运行哪些服务。并且由于容器之间的网络隔离，各个应用间难以进行通讯。可能有的人会说 Docker 也提供了 Docker networking 呀，但是你用起来就会发现 Docker networking 太鸡肋了，难以满足实际需求。

------


