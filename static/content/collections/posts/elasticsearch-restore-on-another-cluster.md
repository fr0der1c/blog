---
title: Elasticsearch 备份并在另一个集群恢复
created_at: 2018-11-07T14:43:21.767Z
tags:
  - Elasticsearch
authors: Frederic Chan
categories: Operation
meta:
  keywords: elasticsearch op
isPage: false
isFeatured: false
hero:
  image: /images/uploads/elsaticsearch_logo.png
excerpt: 最近需要把一个 ES 集群的数据迁移到另一个 ES 集群。写篇文章简要记录一下备份恢复的过程。
---
1. 在 `elasticsearch.yml` 中新增 `path.repo: ["/var/backups"]`，其中 `/var/backups` 为你想要备份到的目录，需要先手动创建。然后重启 ES

2. 新建一个 backup：

{"widget":"qards-code","config":"eyJjb2RlIjoiY3VybCAtWFBVVCBcImh0dHA6Ly9sb2NhbGhvc3Q6OTIwMC9fc25hcHNob3QvbXlfYmFja3VwXCIgLUggJ0NvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vanNvbicgLWQnXG57XG4gIFwidHlwZVwiOiBcImZzXCIsXG4gIFwic2V0dGluZ3NcIjoge1xuICAgIFwibG9jYXRpb25cIjogXCIvdmFyL2JhY2t1cHNcIlxuICB9XG59JyAtdSBlbGFzdGljOnBhc3N3b3JkIiwibGFuZ3VhZ2UiOiJzaGVsbCJ9"}

3. 新建一个 snapshot：

{"widget":"qards-code","config":"eyJjb2RlIjoiY3VybCAtWCBQVVQgXCJsb2NhbGhvc3Q6OTIwMC9fc25hcHNob3QvbXlfYmFja3VwL3NuYXBzaG90XzE/d2FpdF9mb3JfY29tcGxldGlvbj10cnVlXCIgLUggJ0NvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vanNvbicgLWQnXG57XG7CoCBcImluZGljZXNcIjogXCJhcG0qXCIsXG7CoCBcImlnbm9yZV91bmF2YWlsYWJsZVwiOiB0cnVlLFxuwqAgXCJpbmNsdWRlX2dsb2JhbF9zdGF0ZVwiOiBmYWxzZVxufVxuJyAtdSBlbGFzdGljOnBhc3N3b3JkIiwibGFuZ3VhZ2UiOiJzaGVsbCJ9"}

4. 可以用 `curl "localhost:9200/_snapshot/my_backup/snapshot_1" -u elastic:password` 查看备份的状态：

{"widget":"qards-code","config":"eyJjb2RlIjoie1xuwqAgXCJzbmFwc2hvdHNcIjogW1xuwqAgwqAge1xuwqAgwqAgwqAgXCJzbmFwc2hvdFwiOiBcInNuYXBzaG90XzFcIixcbsKgIMKgIMKgIFwidXVpZFwiOiBcImpCWjVJbGg3VGJpQXZuN3k1ckt2S0FcIixcbsKgIMKgIMKgIFwidmVyc2lvbl9pZFwiOiA2MDIwNDk5LFxuwqAgwqAgwqAgXCJ2ZXJzaW9uXCI6IFwiNi4yLjRcIixcbsKgIMKgIMKgIFwiaW5kaWNlc1wiOiBbXG7CoCDCoCDCoCDCoCBcImFwbS02LjMuMi10cmFuc2FjdGlvbi0yMDE4LjEwLjMwXCIsXG7CoCDCoCDCoCDCoCBcImFwbS02LjMuMi1zcGFuLTIwMTguMTAuMDZcIixcbsKgIMKgIMKgIF0sXG7CoCDCoCDCoCBcImluY2x1ZGVfZ2xvYmFsX3N0YXRlXCI6IGZhbHNlLFxuwqAgwqAgwqAgXCJzdGF0ZVwiOiBcIlNVQ0NFU1NcIixcbsKgIMKgIMKgIFwic3RhcnRfdGltZVwiOiBcIjIwMTgtMTEtMDZUMTQ6NDI6MzUuMzI2WlwiLFxuwqAgwqAgwqAgXCJzdGFydF90aW1lX2luX21pbGxpc1wiOiAxNTQxNTE1MzU1MzI2LFxuwqAgwqAgwqAgXCJlbmRfdGltZVwiOiBcIjIwMTgtMTEtMDZUMTY6MjI6NDQuMDI4WlwiLFxuwqAgwqAgwqAgXCJlbmRfdGltZV9pbl9taWxsaXNcIjogMTU0MTUyMTM2NDAyOCxcbsKgIMKgIMKgIFwiZHVyYXRpb25faW5fbWlsbGlzXCI6IDYwMDg3MDIsXG7CoCDCoCDCoCBcImZhaWx1cmVzXCI6IFtdLFxuwqAgwqAgwqAgXCJzaGFyZHNcIjoge1xuwqAgwqAgwqAgwqAgXCJ0b3RhbFwiOiAyMjEsXG7CoCDCoCDCoCDCoCBcImZhaWxlZFwiOiAwLFxuwqAgwqAgwqAgwqAgXCJzdWNjZXNzZnVsXCI6IDIyMVxuwqAgwqAgwqAgfVxuwqAgwqAgfVxuwqAgXVxufSIsImxhbmd1YWdlIjoiIn0="}

5. 把 `/var/backups` 打包拷贝到新的服务器并恢复到原位置，然后按照步骤 1、2 新建 backup
6. `curl -X POST /_snapshot/my_backup/snapshot_1/_restore`
